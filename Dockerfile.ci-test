# syntax=docker/dockerfile:1
# Test Dockerfile for Tcl/Tk on Ubuntu 25.04
# Using 25.04 (plucky) instead of 24.04 LTS because it has:
# - Tcl/Tk 9.0.1 packages
# - BWidget 1.10.1 with Tcl 9 support
# - libtk-img 2.0.1 with Tcl 9 support
#
# Usage:
#   Tcl/Tk 9.0 (default):
#     docker build -f Dockerfile.ci-test -t tk-ci-test-9 .
#
#   Tcl/Tk 8.6:
#     docker build -f Dockerfile.ci-test --build-arg TCL_VERSION=8.6 -t tk-ci-test-8 .
#
#   Run tests:
#     docker run --rm -v $(pwd)/screenshots:/app/screenshots tk-ci-test-9
#
#   Or use rake tasks:
#     rake docker:test                    # Test with Tcl 9.0
#     TCL_VERSION=8.6 rake docker:test    # Test with Tcl 8.6
#     rake docker:clean                   # Remove dangling images

# Ruby source - just grab pre-built Ruby, no compilation needed
ARG RUBY_VERSION=3.4
FROM ruby:${RUBY_VERSION}-slim AS ruby-source

#############################################
# BUILDER STAGE - compile extension only
#############################################
FROM ubuntu:25.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Skip docs/man pages to speed up apt installs
RUN echo 'path-exclude=/usr/share/doc/*' > /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/man/*' >> /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/locale/*' >> /etc/dpkg/dpkg.cfg.d/excludes

COPY --from=ruby-source /usr/local /usr/local
ENV PATH="/usr/local/bin:${PATH}"

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    cmake \
    ca-certificates \
    libyaml-dev \
    libffi-dev \
    libreadline-dev \
    zlib1g-dev \
    libssl-dev \
    libx11-dev \
    libxcursor-dev

# Tcl/Tk dev packages for compilation
ARG TCL_VERSION=9.0
ENV TCL_VERSION=${TCL_VERSION}

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        apt-get update && apt-get install -y --no-install-recommends tcl-dev tk-dev; \
    else \
        apt-get update && apt-get install -y --no-install-recommends tcl9.0-dev tk9.0-dev libtommath-dev; \
    fi

# Ubuntu 25.04 pkg-config bug: tk9.0.pc requires "tcl" but only tcl9.0.pc exists
RUN if [ "${TCL_VERSION}" != "8.6" ]; then \
        MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH) && \
        ln -sf tcl9.0.pc /usr/lib/${MULTIARCH}/pkgconfig/tcl.pc && \
        ln -sf tk9.0.pc /usr/lib/${MULTIARCH}/pkgconfig/tk.pc; \
    fi

WORKDIR /app
COPY . .

ENV BUNDLE_PATH=/usr/local/bundle
RUN --mount=type=cache,target=/bundle-cache \
    if [ -d /bundle-cache/ruby ]; then \
        echo "Restoring cached gems..." && \
        mkdir -p $BUNDLE_PATH && \
        cp -a /bundle-cache/* $BUNDLE_PATH/; \
    fi && \
    (bundle check || bundle install) && \
    cp -a $BUNDLE_PATH/* /bundle-cache/

# Compile the main extension
RUN MAKEFLAGS="-j$(nproc)" MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH) && \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        bundle exec rake compile -- --with-tcltkversion=8.6 \
            --with-tcl-lib=/usr/lib/${MULTIARCH} \
            --with-tk-lib=/usr/lib/${MULTIARCH} \
            --with-tcl-include=/usr/include/tcl8.6 \
            --with-tk-include=/usr/include/tcl8.6; \
    else \
        bundle exec rake compile -- --with-tcltkversion=9.0 \
            --with-tcl-lib=/usr/lib/${MULTIARCH} \
            --with-tk-lib=/usr/lib/${MULTIARCH} \
            --with-tcl-include=/usr/include/tcl9.0 \
            --with-tk-include=/usr/include/tk9.0; \
    fi

# Compile trofs extension
RUN bundle exec rake compile:trofs

# Build tkdnd from source (no prebuilt binaries for Linux Tcl 9.0)
ARG TKDND_VERSION=2.9.5
RUN git clone --depth 1 --branch tkdnd-release-test-v${TKDND_VERSION} \
        https://github.com/petasis/tkdnd.git /tmp/tkdnd && \
    cd /tmp/tkdnd && \
    mkdir build && cd build && \
    MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH) && \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr/share/tcltk \
            -Dwith-tcl=/usr/lib/${MULTIARCH}; \
    else \
        cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr/share/tcltk \
            -Dwith-tclsh=/usr/bin/tclsh9.0 \
            -DTCL_INCLUDE_PATH=/usr/include/tcl9.0 \
            -DTK_INCLUDE_PATH=/usr/include/tk9.0 \
            -DTCL_LIBRARY=/usr/lib/${MULTIARCH}/libtcl9.0.so \
            -DTK_LIBRARY=/usr/lib/${MULTIARCH}/libtk9.0.so \
            -DTCL_STUB_LIBRARY=/usr/lib/${MULTIARCH}/libtclstub9.0.a \
            -DTK_STUB_LIBRARY=/usr/lib/${MULTIARCH}/libtkstub9.0.a; \
    fi && \
    make -j$(nproc) && \
    make install && \
    rm -rf /tmp/tkdnd

#############################################
# RUNTIME STAGE - slim image for running tests
#############################################
FROM ubuntu:25.04 AS runtime

ENV DEBIAN_FRONTEND=noninteractive

# Skip docs/man pages
RUN echo 'path-exclude=/usr/share/doc/*' > /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/man/*' >> /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/locale/*' >> /etc/dpkg/dpkg.cfg.d/excludes

# Runtime-only dependencies (no build-essential, no *-dev)
ARG TCL_VERSION=9.0
ENV TCL_VERSION=${TCL_VERSION}

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    xvfb \
    imagemagick \
    perceptualdiff \
    fonts-noto-color-emoji \
    fonts-noto-cjk \
    bwidget \
    make \
    libyaml-0-2 \
    libffi8 \
    libreadline8 \
    zlib1g \
    libssl3t64 \
    libxcursor1 && \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        apt-get install -y --no-install-recommends tcl tk libtk-img; \
    else \
        apt-get install -y --no-install-recommends tcl9.0 tk9.0 && \
        ln -sf /usr/bin/tclsh9.0 /usr/bin/tclsh && \
        ARCH=$(dpkg --print-architecture) && \
        apt-get install -y --no-install-recommends wget && \
        wget -q -O /tmp/libjpeg62-turbo.deb "http://ftp.us.debian.org/debian/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_2.1.5-4_${ARCH}.deb" && \
        wget -q -O /tmp/libtk-img.deb "http://ftp.us.debian.org/debian/pool/main/libt/libtk-img/libtk-img_2.1.0+dfsg1-1_${ARCH}.deb" && \
        dpkg -i /tmp/libjpeg62-turbo.deb /tmp/libtk-img.deb && \
        rm /tmp/libjpeg62-turbo.deb /tmp/libtk-img.deb && \
        apt-get purge -y wget && apt-get autoremove -y; \
    fi && \
    rm -rf /var/lib/apt/lists/*

ENV TCLLIBPATH=/usr/share/tcltk

# Copy Ruby and gems from builder
COPY --from=builder /usr/local /usr/local

# Copy tkdnd extension built in builder stage
COPY --from=builder /usr/share/tcltk/tkdnd* /usr/share/tcltk/
ENV PATH="/usr/local/bin:${PATH}"
ENV BUNDLE_PATH=/usr/local/bundle

WORKDIR /app
COPY --from=builder /app /app

# Screenshots will be in /app/screenshots/unverified/linux/tcl{version}/
# exec replaces bash so SIGINT (Ctrl+C) goes directly to rake
CMD ["bash", "-c", "Xvfb :99 -screen 0 1024x768x24 & sleep 1 && exec env DISPLAY=:99 bundle exec rake test"]
