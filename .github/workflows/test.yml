name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-tcl9:
    name: test (tcl 9.0)
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker mount caches
      uses: actions/cache@v4
      with:
        path: cache-mount
        key: docker-mount-tcl9-${{ hashFiles('Dockerfile.ci-test') }}
        restore-keys: docker-mount-tcl9-

    - name: Restore Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "var-cache-apt": "/var/cache/apt",
            "var-lib-apt": "/var/lib/apt",
            "root-bundle": "/root/.bundle"
          }
        skip-extraction: ${{ steps.cache.outputs.cache-hit }}
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: TCL_VERSION=9.0
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-9:latest
        cache-from: type=gha,scope=tcl9
        cache-to: type=gha,mode=max,scope=tcl9

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -v ${{ github.workspace }}/coverage:/app/coverage \
          -e TCL_VERSION=9.0 \
          -e COVERAGE=1 \
          tk-ci-test-9:latest

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-tcl9
        path: coverage/
        retention-days: 30

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-tcl9
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-tcl9
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7

  test-tcl8:
    name: test (tcl 8.6)
    runs-on: ubuntu-24.04
    needs: test-tcl9
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker mount caches
      uses: actions/cache@v4
      with:
        path: cache-mount
        key: docker-mount-tcl8-${{ hashFiles('Dockerfile.ci-test') }}
        restore-keys: docker-mount-tcl8-

    - name: Restore Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "var-cache-apt": "/var/cache/apt",
            "var-lib-apt": "/var/lib/apt",
            "root-bundle": "/root/.bundle"
          }
        skip-extraction: ${{ steps.cache.outputs.cache-hit }}
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: TCL_VERSION=8.6
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-8:latest
        cache-from: type=gha,scope=tcl8
        cache-to: type=gha,mode=max,scope=tcl8

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -e TCL_VERSION=8.6 \
          tk-ci-test-8:latest

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-tcl8
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-tcl8
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7
