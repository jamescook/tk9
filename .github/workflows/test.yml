name: CI

on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build and cache Tcl/Tk 9.0 first (single job, no matrix)
  build-tcltk9:
    name: build tcl/tk 9.0
    runs-on: ubuntu-24.04
    env:
      TCL_VERSION: "9.0.1"
      TK_VERSION: "9.0.1"
    steps:
    - name: Cache Tcl/Tk 9.0 build
      id: cache-tcltk
      uses: actions/cache@v4
      with:
        path: /opt/tcltk9
        key: tcltk-${{ env.TCL_VERSION }}-${{ env.TK_VERSION }}-ubuntu2404

    - name: Install build dependencies
      if: steps.cache-tcltk.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl libx11-dev libxft-dev libxss-dev

    - name: Build Tcl from source
      if: steps.cache-tcltk.outputs.cache-hit != 'true'
      run: |
        cd /tmp
        curl -LO "https://prdownloads.sourceforge.net/tcl/tcl${TCL_VERSION}-src.tar.gz"
        tar xzf tcl${TCL_VERSION}-src.tar.gz
        rm -rf tcl${TCL_VERSION}/pkgs/sqlite3*
        cd tcl${TCL_VERSION}/unix
        ./configure --prefix=/opt/tcltk9 --disable-zipfs
        make -j$(nproc)
        sudo make install

    - name: Build Tk from source
      if: steps.cache-tcltk.outputs.cache-hit != 'true'
      run: |
        cd /tmp
        curl -LO "https://prdownloads.sourceforge.net/tcl/tk${TK_VERSION}-src.tar.gz"
        tar xzf tk${TK_VERSION}-src.tar.gz
        cd tk${TK_VERSION}/unix
        ./configure --prefix=/opt/tcltk9 --with-tcl=/opt/tcltk9/lib
        make -j$(nproc)
        sudo make install

  # Tcl 9.x Ruby builds (parallel matrix, cache already populated)
  build-tcl9:
    name: build (ruby ${{ matrix.ruby }}, tcl 9.0)
    needs: build-tcltk9
    strategy:
      fail-fast: false
      matrix:
        ruby: [ '3.4' ]
    runs-on: ubuntu-24.04
    env:
      TCL_VERSION: "9.0.1"
      TK_VERSION: "9.0.1"
    steps:
    - uses: actions/checkout@v6

    - name: Restore Tcl/Tk 9.0 cache
      uses: actions/cache@v4
      with:
        path: /opt/tcltk9
        key: tcltk-${{ env.TCL_VERSION }}-${{ env.TK_VERSION }}-ubuntu2404

    - name: Install build and runtime dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: libx11-dev libxft-dev libxss-dev xvfb
        execute_install_scripts: true

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}

    - name: Install gem dependencies
      run: |
        gem install bundler --no-document
        bundle install

    - name: Compile extension
      env:
        LD_LIBRARY_PATH: /opt/tcltk9/lib
      run: |
        rake compile -- --with-tcltkversion=9.0 \
          --with-tcl-lib=/opt/tcltk9/lib \
          --with-tk-lib=/opt/tcltk9/lib \
          --with-tcl-include=/opt/tcltk9/include \
          --with-tk-include=/opt/tcltk9/include

    - name: Verify extension loads
      env:
        LD_LIBRARY_PATH: /opt/tcltk9/lib
      run: |
        xvfb-run ruby -I lib -r tk -e "puts \"Tk loaded! TCL_VERSION=#{Tk::TCL_VERSION}\""

  visual-regression-tcl9:
    name: visual regression (tcl 9.0)
    needs: build-tcl9
    runs-on: ubuntu-24.04
    env:
      TCL_VERSION: "9.0.1"
      TK_VERSION: "9.0.1"
    steps:
    - uses: actions/checkout@v6

    - name: Restore Tcl/Tk 9.0 cache
      uses: actions/cache@v4
      with:
        path: /opt/tcltk9
        key: tcltk-${{ env.TCL_VERSION }}-${{ env.TK_VERSION }}-ubuntu2404

    - name: Install build and runtime dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: libx11-dev libxft-dev libxss-dev xvfb imagemagick perceptualdiff
        execute_install_scripts: true

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'

    - name: Install gem dependencies
      run: |
        gem install bundler --no-document
        bundle install

    - name: Compile extension
      env:
        LD_LIBRARY_PATH: /opt/tcltk9/lib
      run: |
        rake compile -- --with-tcltkversion=9.0 \
          --with-tcl-lib=/opt/tcltk9/lib \
          --with-tk-lib=/opt/tcltk9/lib \
          --with-tcl-include=/opt/tcltk9/include \
          --with-tk-include=/opt/tcltk9/include

    - name: Run visual regression tests
      env:
        LD_LIBRARY_PATH: /opt/tcltk9/lib
      run: timeout 60 xvfb-run --auto-servernum rake test

    - name: Upload failed screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failed-screenshots-tcl9
        path: |
          screenshots/unverified/
          screenshots/diffs/
        retention-days: 7

  # Tcl 8.6 builds only run after all Tcl 9.x jobs pass
  build-tcl8:
    name: build (ruby ${{ matrix.ruby }}, tcl 8.6)
    needs: visual-regression-tcl9
    strategy:
      fail-fast: false
      matrix:
        ruby: [ '3.4' ]
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
    - name: Install Tcl/Tk
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: tcl-dev tk-dev xvfb
        execute_install_scripts: true
    - name: Install gem dependencies
      run: |
        gem install bundler --no-document
        bundle install
    - name: Compile extension
      run: |
        rake compile -- --with-tcltkversion=8.6 \
          --with-tcl-lib=/usr/lib/x86_64-linux-gnu \
          --with-tk-lib=/usr/lib/x86_64-linux-gnu \
          --with-tcl-include=/usr/include/tcl8.6 \
          --with-tk-include=/usr/include/tcl8.6
    - name: Verify extension loads
      run: |
        xvfb-run ruby -I lib -r tk -e "puts \"Tk loaded! TCL_VERSION=#{Tk::TCL_VERSION}\""

  visual-regression-tcl8:
    name: visual regression (tcl 8.6)
    needs: build-tcl8
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
    - name: Install system dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: tcl-dev tk-dev xvfb imagemagick perceptualdiff
        execute_install_scripts: true
    - name: Install gem dependencies
      run: |
        gem install bundler --no-document
        bundle install
    - name: Compile extension
      run: |
        rake compile -- --with-tcltkversion=8.6 \
          --with-tcl-lib=/usr/lib/x86_64-linux-gnu \
          --with-tk-lib=/usr/lib/x86_64-linux-gnu \
          --with-tcl-include=/usr/include/tcl8.6 \
          --with-tk-include=/usr/include/tcl8.6
    - name: Run visual regression tests
      run: timeout 60 xvfb-run --auto-servernum rake test

    - name: Upload failed screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failed-screenshots-tcl8
        path: |
          screenshots/unverified/
          screenshots/diffs/
        retention-days: 7
